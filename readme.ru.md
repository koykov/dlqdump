# DLQ dump

`dlqdump` это реализация `DLQ` очереди для пакета [`queue`](https://github.com/koykov/queue), которая позволяет дампить
протёкшие элементы в какое-то хранилище: диск, облако, и т.п.

`DLQ` это вспомогательная очередь, куда перенаправляются элементы, которым не нашлось места в очереди по причине
достижения лимита воркеров или по причине ошибки (настраиваемое поведение).

Этот пакет также содержит обратное решение, которое позволяет восстановить элементы из дампа и вернуть их в исходную
очередь (см раздел "Восстановление").

## Дампинг

Дампинг-компонент реализован в виде очереди (т.к. `DLQ` должен реализовывать соответствующий
[интерфейс очереди](https://github.com/koykov/queue/blob/master/interface.go#L4)) и называется также `Queue`.

Дампинг-очередь инициализируется с помощью структуры
[`Config`](https://github.com/koykov/dlqdump/blob/master/config.go#L18).

Базовый параметр конфига это `Version`. Позволяет задать версию дампа, которая будет проверяться при чтении из дампа и
укажет являются ли дамп-данные обратно совместимыми (фактически, можно ли попробовать их вернуть в исходную очередь).

### Настройки сброса

Далее параметрами `Capacity` и `FlushInterval` настраивается как часто очереди будет необходимо "сбрасывать" данные в
хранилище. `Capacity` ограничивает максимальную ёмкость очереди в байтах, а `FlushInterval` ограничивает сколько очередь
может ждать поступления данных до сброса (начиная с момента поступления первого элемента).

Это требует пояснения. `Capacity` измеряется именно в байтах, а не элементах потому, что предполагается сброс данных в
хранилище, которое может ограничивать размер (например какое-то облачное хранилище с ограничением на размер файлов).
Таким образом очередь может накопить только определённое количество сериализованных данных (см. раздел "Сериализация") и
произведёт сброс данных в хранилище по достижении этого лимита. Этот параметр является обязательным.

Паралельно работает ограничение по `FlushInterval`. Запоминается момент поступления первого элемента (с начала работы
очереди или с момента последнего сброса) и по прошествии `FlushInterval`происходит сброс с причиной "достигнут интервал".
Такое поведение необходимо для случаев, когда элементы поступают очень редко и не способны заполнить очередь до
`Capacity` лимита. Благодаря `FlushInterval` элементы не будут висеть бесконечно в очереди и будут сброшены в хранилище,
пусть даже размер порции будет маленьким.

Итого получается, что очередь ждёт поступления новых элементов, обрабатывает их и следит что наступит первым: будет
достигнут `Capacity` лимит или пройдёт `FlushInterval`. Затем произойдёт сброс в хранилище.

Замечу, что при закрытии очереди, содержащей данные, произойдёт принудительный сброс, без учёта обоих параметров и
только затем очередь будет закрыта.

### Сериализация

`Queue` имеет два уровня абстракции. Первый задаётся параметром `Encoder`. Это специальный компонент, который должен
реализовывать интерфейс [`Encoder`](https://github.com/koykov/dlqdump/blob/master/encoder.go). Этот компонент принимает
произвольный элеменент и пробует его сериализовать в буфер `dst`. Сериализованные данные будут далее перенаправлены в
хранилище.

`dlqdump` из коробки содержит несколько енкодеров:
[builtin](https://github.com/koykov/dlqdump/blob/master/encoder/builtin.go) и
[marshaller](https://github.com/koykov/dlqdump/blob/master/encoder/marshaller.go).
Первый позволяет сериализовать примитивные строковые типы данных, а также объекты реализующий `Byter` и `Stringer`
интерфейсы.
Второй интереснее, с его помощью можно сериализовать сложные структуры, например
[protobuf](https://en.wikipedia.org/wiki/Protocol_Buffers) объекты.

### Запись дампов

Это второй слой абстракции. Он задаётся параметром `Writer` и должен реализовывать интерфейс
[`Writer`](https://github.com/koykov/dlqdump/blob/master/writer.go). Этот объект, согласно своей внутренней логике,
использует переданные очередью версию и сериализованные `Encoder`-ом данные для создания дампов. Например, `dlqdump` из
коробки содержит реализацию `Writer`-а, которая [пишет данные на диск](https://github.com/koykov/dlqdump/tree/master/fs).
Но вы можете написать любую удобную вам реализацию, например для записи в Google Cloud или куда-то ещё.

## Ссылки

* https://en.wikipedia.org/wiki/Dead_letter_queue
* https://cloud.yandex.com/en/docs/message-queue/concepts/dlq
